# 树莓派网络设置



## 系统基础配置

### root 设置

```shell
# 设置root用户密码
sudo passwd root
# 启用root
sudo passwd --unlock root
```

### 配置ssh server

```shell
apt-get install openssh-server
sed -i "s/^#PermitRootLogin.*/PermitRootLogin yes/g" /etc/ssh/sshd_config
systemctl restart ssh
```

## 网络配置

### 采用 NetworkManager 服务

```shell
# 查看当前网口
nmcli device status
# 配置两个网口的静态IP
nmcli connection modify eth0 ipv4.addresses 198.18.36.129/16 ipv4.gateway 198.18.36.1 ipv4.dns "8.8.8.8 8.8.4.4" ipv4.method manual
nmcli connection modify wlan0 ipv4.addresses 192.168.137.185/24 ipv4.gateway 192.168.137.1 ipv4.dns "8.8.8.8 8.8.4.4" ipv4.method manual
# 重置网络服务
systemctl restart NetworkManager
```

### 采用 DHCP

Install DHCP

```
apt-get update
apt-get install dhcpcd
```

配置静态 ip

```shell
vim /etc/dhcpcd.conf

# 输入以下 网络配置
interface eth0
static ip_address=198.18.36.129/16
static routers=198.18.36.1
static domain_name_servers=8.8.8.8 8.8.4.4

interface wlan0
static ip_address=192.168.137.185/24
static routers=192.168.137.1
static domain_name_servers=8.8.8.8 8.8.4.4
:wq
# 重启配置
systemctl restart dhcpcd
```

旧版本的 Raspbian 或者未启用 `dhcpcd` 的树莓派系统

```shell
vim /etc/network/interfaces

# 输入以下内容
auto eth0
iface eth0 inet static
    address 198.18.36.129
    netmask 255.255.0.0
    gateway 198.18.36.1
    dns-nameservers 8.8.8.8 8.8.4.4

auto wlan0
iface wlan0 inet static
    address 192.168.137.185
    netmask 255.255.255.0
    gateway 192.168.137.1
    dns-nameservers 8.8.8.8 8.8.4.4
:wq

# 重启服务
systemctl restart networking
```



## 网关配置

### 查看网关配置

```shell
ip route
# 可能出现的打印
default via 198.18.36.1 dev eth0 proto static metric 100
default via 192.168.137.1 dev wlan0 proto static metric 600
192.168.137.0/24 dev wlan0 proto kernel scope link src 192.168.137.185 metric 600
198.18.0.0/16 dev eth0 proto kernel scope link src 198.18.36.129 metric 100
```

### 配置默认网关

*以上面为例*

```shell
# 删除高优先级的 ETH0 网关
ip route del default via 198.18.36.1 dev eth0
# 提高wlan0网关优先级
ip route add default via 192.168.137.1 dev wlan0 metric 100
# 测试网关
ping 8.8.8.8
```

```shell
# 局域网其他设备设置树莓派外网网卡为默认网关
route add default gw 198.18.36.129
```



## 设置网络转发

### 开启转发

```shell
vim /etc/sysctl.conf
# 添加
net.ipv4.ip_forward=1
:wq
# 保存后使设置生效
sysctl -p
```

### 配置 NAT（网络地址转换）

使用 `iptables` 配置 NAT 规则，将 `eth0` 的数据通过 `wlan0` 转发到外网

```shell
# 安装服务
apt install iptables-persistent
# 清空规则
iptables -F FORWARD
# 查看规则
iptables -L FORWARD -n -v
# 打印如下
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

# 执行配置命令
iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o wlan0 -j ACCEPT
# 保存配置
iptables-save > /etc/iptables/rules.v4

# 查看规则
iptables -L FORWARD -n -v
iptables -t nat -L POSTROUTING -n -v
iptables -t nat -L -n -v
```

### NAT配置排查

```shell
iptables -L FORWARD -n -v
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    0     0 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0
    0     0 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0
    0     0 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    0     0 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0
    
  
iptables -t nat -L -n -v
# 打印如下
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
  401 81678 MASQUERADE  0    --  *      wlan0   0.0.0.0/0            0.0.0.0/0
    0     0 MASQUERADE  0    --  *      wlan0   0.0.0.0/0            0.0.0.0/0
    0     0 MASQUERADE  0    --  *      wlan0   0.0.0.0/0            0.0.0.0/0
    
# 清空规则
iptables -F FORWARD
# 配置规则
iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o wlan0 -j ACCEPT

iptables -L FORWARD -n -v
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    2   168 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    7   526 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0
    
 
iptables -t nat -L -n -v
# 打印如下
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    2   168 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    7   526 ACCEPT     0    --  eth0   wlan0   0.0.0.0/0            0.0.0.0/0

```

